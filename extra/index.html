<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Extra functionality - MicroTBX User Manual</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Extra functionality";
        var mkdocs_page_input_path = "extra.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> MicroTBX User Manual
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../apiref/">API reference</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../misra/">MISRA compliance</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../license/">License</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../assertions/">Assertions</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../critsect/">Critical sections</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../heap/">Heap</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../mempools/">Memory pools</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../lists/">Linked lists</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../random/">Random numbers</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../checksum/">Checksums</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../crypto/">Cryptography</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../platform/">Platform</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">Extra functionality</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#microtbx-for-freertos">MicroTBX for FreeRTOS</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#heap-management">Heap management</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#assertions">Assertions</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#c-new-and-delete-using-microtbx-memory-pools">C++ new and delete using MicroTBX memory pools</a>
    </li>
    </ul>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">MicroTBX User Manual</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Extra functionality</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/feaser/microtbx/edit/master/docs/extra.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="extra-functionality">Extra functionality</h1>
<p>You can find some optional and extra functionality in the directory <code>source/extra</code>. This section provides additional information regarding this functionality.</p>
<h2 id="microtbx-for-freertos">MicroTBX for FreeRTOS</h2>
<p>The <a href="https://www.freertos.org">FreeRTOS</a> real-time operating system is widely used in the embedded industry. No wonder, because it's free, open source, high quality, MISRA compliant and maintained by <a href="https://aws.amazon.com/">AWS</a>. </p>
<p>Whenever you use both FreeRTOS and MicroTBX, a few pieces of functionality are redundant. Both MicroTBX and FreeRTOS offer heap management and assertion functionality. There is nothing wrong with using both. However, if you'd like to reap the benefits of MicroTBX, while also using FreeRTOS, consider using the files in directory:</p>
<ul>
<li><code>source/extra/freertos/</code></li>
</ul>
<h3 id="heap-management">Heap management</h3>
<p>FreeRTOS ships with a few different examples for heap management. Some allow just one-time memory allocation, some feature functionality to release allocated memory again, with minimal memory fragmentation. You can find these examples in directory:</p>
<ul>
<li><code>FreeRTOS/Source/portable/MemMang/</code></li>
</ul>
<p>The file <code>tbx_freertos.c</code> offers an alternative heap management implementation, using MicroTBX's memory pools. This allows you to dynamically allocate and release memory on the heap, for your application's FreeRTOS objects.</p>
<p>To use this heap management solution, you just need to remove the <code>heap_x.c</code> source file from your project and compile and link <code>tbx_freertos.c</code> instead.</p>
<h3 id="assertions">Assertions</h3>
<p>In the FreeRTOS configuration header file <code>FreeRTOSConfig.h</code>, you can add and configure the <code>configASSERT</code> macro to enable assertions in the FreeRTOS code base. MicroTBX includes an assertion module that you can use for this. The easiest way to link the MicroTBX assertion <code>TBX_ASSERT</code> macro to the FreeRTOS <code>configASSERT</code> macro, is by including the <code>tbx_freertos.h</code> header file all the way at the end. Just before the last <code>#endif</code>:</p>
<pre><code class="language-c">#define INCLUDE_vTaskCleanUpResources                 1
#define INCLUDE_vTaskSuspend                          1
#define INCLUDE_vTaskDelayUntil                       1
#define INCLUDE_vTaskDelay                            1
#define INCLUDE_uxTaskGetStackHighWaterMark           1

/* Use MicroTBX assertion in FreeRTOS. */
#include &quot;tbx_freertos.h&quot; /* &lt;---- ADD THIS LINE */

#endif /* FREERTOS_CONFIG_H */
</code></pre>
<p>Just make sure to add the directory, where the <code>tbx_freertos.h</code> resides, to your compiler's search path for included header files.</p>
<p>Alternatively, you can directly add and configure the <code>configASSERT</code> macro as follows in <code>FreeRTOSConfig.h</code>:</p>
<pre><code class="language-c">#include &quot;microtbx.h&quot;
#define configASSERT( x ) TBX_ASSERT( x )
</code></pre>
<h2 id="c-new-and-delete-using-microtbx-memory-pools">C++ new and delete using MicroTBX memory pools</h2>
<p>On a microcontroller it is totally fine to dynamically allocate memory on the heap using <code>new</code> (or <code>malloc</code>). It gets potentially troublesome when you also release it at run-time using <code>delete</code> (or <code>free</code>). Multiple allocation and release operations can cause memory fragmentation. In a worst case scenario this leads to memory allocation failures, because of running out of heap memory.</p>
<p>A possible solution is by dynamically allocating memory using memory pools. This lowers the risk of memory fragmentation. With a carefully selected memory pool setup, you can even eliminate this risk completely. Allowing you to dynamically allocate and release memory during run-time. MicroTBX includes a ready-made memory pool module that can be used for this purpose.</p>
<p>One way to approach this is by using C++ <em>placement new</em> instead of the usual <em>new</em>. This allows you the first allocate memory from a memory pool and then place the new object exactly at that memory, instead of having the <code>new</code> operator do the allocation. The only issue with this is that there is no <em>placement delete</em>. This means that to delete the object, you need to manually call its destructor and then give the allocated memory back to the memory pool. Definitely an option, it just requires a bit more work.</p>
<p>Another approach is to overload the default <code>new</code> and <code>delete</code> operators to do all the memory allocation and release using memory pools automatically. The following source-file implements these operator overloads for the <a href="https://developer.arm.com/Tools%20and%20Software/GNU%20Toolchain">GNU ARM Embedded</a> toolchain:</p>
<ul>
<li><code>source/extra/cplusplus/tbxcxx.cpp</code></li>
</ul>
<p>By compiling and linking this source file with your project, the global <code>new</code> and <code>delete</code> operators are overloaded, such that they by default always use the memory pools module of MicroTBX. This also apply to objects created using smart pointers.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../platform/" class="btn btn-neutral float-left" title="Platform"><span class="icon icon-circle-arrow-left"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/feaser/microtbx" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../platform/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
